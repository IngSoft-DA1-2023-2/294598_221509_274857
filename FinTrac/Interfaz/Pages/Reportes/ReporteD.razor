@page "/home/{Id:int}/{Correo}/ReporteD"
@inject NavigationManager NavigationManager;
@using BussinesLogic
@using Domain
@inject UsuarioLogic UsuarioLogic;
@inject EspacioLogic EspacioLogic;
@inject Persistencia Persistencia;

<PageTitle>FinTrac Reportes</PageTitle>
<TituloRosado Titulo="Reporte de Gastos por Tarjeta" Subtitulo=""></TituloRosado>

<div style="position:relative;" class="mt-4">
	<h3 class="text-lg font-medium mb-2">Gastos por Tarjeta</h3>
	<div style="display:flex; flex-direction:column" class="mt-4">
		<div style="flex-grow: 1; padding-bottom:15px" class="flex flex-col space-y-2">
			<label for="cardSelector" class="text-sm font-medium text-gray-500">Seleccione una tarjeta:</label>
			<select @bind="tarjetaActual" id="cardSelector" name="mes">
				@foreach (string tarjeta in generarListaTarjetas())
				{
					<option value="@tarjeta"> @tarjeta </option>
				}
			</select>
		</div>
		<a style="position:relative; flex-grow:1; cursor:pointer; width:50%; left:23%; align-items:center; justify-content:center; display: flex; font-size: 25px" class="text-white bg-gradient-to-br from-pink-500 to-orange-400 hover:bg-gradient-to-bl focus:ring-4 focus:outline-none focus:ring-pink-200 dark:focus:ring-pink-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center mr-2 mb-2" @onclick="generarReporte">Generar Reporte</a>
	</div>

	<div class="flex flex-col space-y-2">
		@if (gastosTarjeta.Count == 0)
		{
			<div style="border: solid; border-color: #d4d4d4; width: 32%; border-radius:9px; left:0%; position:relative; align-items:center; justify-content:center; left:32%">
				<h1 style="padding-left:6px">No hay transacciones que permitan esta operacion.</h1>
			</div>
		}
		else
		{
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-gray-50">
					<tr>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Titulo
						</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Monto $
						</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Fecha
						</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Moneda - Monto
						</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Banco
						</th>
						<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Valor moneda
						</th>
					</tr>
				</thead>
				<tbody class="bg-white divide-y divide-gray-200">
					@foreach (Transaccion transaccion in gastosTarjeta)
					{
						if (transaccion.Moneda != TipoCambiario.PesosUruguayos)
						{
							<tr>
								<td class="px-6 py-4 whitespace-nowrap">
									@transaccion.Titulo
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									$ @(transaccion.Monto * transaccion.EncontrarCambio(reporte.MiEspacio).Pesos)
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									@transaccion.FechaTransaccion
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									@transaccion.Moneda - @transaccion.Monto
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									@(((Credito)transaccion.CuentaMonetaria).BancoEmisor)
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									@transaccion.EncontrarCambio(reporte.MiEspacio).Pesos
								</td>
							</tr>
						}
						else
						{
							<tr>
								<td class="px-6 py-4 whitespace-nowrap">
									@transaccion.Titulo
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									$ @transaccion.Monto
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									@transaccion.FechaTransaccion
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									@transaccion.Moneda
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
									@(((Credito)transaccion.CuentaMonetaria).BancoEmisor)
								</td>
								<td class="px-6 py-4 whitespace-nowrap">
								</td>
							</tr>
						}
					}
				</tbody>
			</table>
		}
	</div>
</div>

@code {
	[Parameter] public int Id { get; set; }
	[Parameter] public string Correo { get; set; }
	public string ErrorMsg { get; set; }
	public Espacio espacio { get; set; }
	public List<Transaccion> gastosTarjeta { get; set; }
	public Reporte reporte = new Reporte();
	public List<Cuenta> cuentas { get; set; }
	public List<Transaccion> transacciones { get; set; }
	public string tarjetaActual { get; set; }

	private void generarReporte()
	{
		gastosTarjeta = reporte.ReporteGastosTarjeta(tarjetaActual);
	}

	public List<string> generarListaTarjetas()
	{
		List<string> toRet = new List<string>();
		foreach (Cuenta cuenta in cuentas)
		{
			if (cuenta is Credito)
			{
				string tarjeta = ((Credito)cuenta).NumeroTarjeta;
				if (!(toRet.Contains(tarjeta)))
				{
					toRet.Add(tarjeta);
				}
			}
		}
		return toRet;
	}

	protected override void OnInitialized()
	{
		tarjetaActual = "1111";
		espacio = EspacioLogic.FindEspacio(Persistencia.Id);
		reporte = new Reporte() { MiEspacio = espacio };
		cuentas = reporte.MiEspacio.Cuentas;
		transacciones = reporte.MiEspacio.Transacciones;
		gastosTarjeta = new List<Transaccion>();
	}
}
